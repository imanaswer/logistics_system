(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,96086,(e,t,a)=>{t.exports=e.r(9187)},83168,e=>{"use strict";let t="http://localhost:8001";console.log("ðŸ”— Backend API URL:",t),e.s(["API_URL",0,t])},45494,e=>{"use strict";var t=e.i(48277),a=e.i(30668),s=e.i(18033),l=e.i(96086),r=e.i(83168);let n=`${r.API_URL}/api`,i={charge_type:"",description:"",amount:"",vat:0,total:0},o=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2.5",d:"M12 4v16m8-8H4"})}),c=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),d=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2.5",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),u=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"3",d:"M5 13l4 4L19 7"})});function x(){let e=(0,l.useRouter)(),r=(0,l.useParams)(),x=r?.jobId,[m,h]=(0,a.useState)(null),[p,b]=(0,a.useState)([]),[g,v]=(0,a.useState)([i]),[f,j]=(0,a.useState)(""),[N,k]=(0,a.useState)(""),[w,y]=(0,a.useState)([]),[C,S]=(0,a.useState)(!0),[_,L]=(0,a.useState)(!1),[A,$]=(0,a.useState)(!1),[B,D]=(0,a.useState)(""),[F,R]=(0,a.useState)(null),T=(0,a.useMemo)(()=>{let e=localStorage.getItem("token");return e?{headers:{Authorization:`Token ${e}`}}:null},[]);(0,a.useEffect)(()=>{T?x&&(async()=>{try{let[e,t,a]=await Promise.all([s.default.get(`${n}/jobs/${x}/`,T),s.default.get(`${n}/chargetypes/`,T),s.default.get(`${n}/invoice-items/?job=${x}`,T)]);h(e.data),j(e.data.transport_document_no??""),k(e.data.vat_number??""),b(t.data);let l=a.data;l&&l.length>0?(v(l.map(e=>({charge_type:String(e.charge_type),description:e.description||"",amount:Number(e.amount),vat:Number(e.vat),total:Number(e.total)}))),y(l.map(e=>e.id))):(v([i]),y([]))}catch(t){console.error("Load error:",t),e.push("/")}finally{S(!1)}})():e.push("/login")},[T,x,e]);let P=async()=>{if(B.trim()&&T)try{let e=(await s.default.post(`${n}/chargetypes/`,{name:B},T)).data;b(t=>[...t,e]),null!==F&&M(F,"charge_type",String(e.id)),$(!1),D(""),R(null)}catch(e){alert("Failed to add header. It might already exist.")}},M=(e,t,a)=>{v(s=>{let l=[...s],r={...l[e],[t]:a},n=""===r.amount?0:Number(r.amount);if("amount"===t||"charge_type"===t){let e=p.find(e=>String(e.id)===r.charge_type);r.vat=e?.name?.toLowerCase().match(/custom|transport|handling|agency|fee|clearance/)?.05*n:0}return r.total=n+r.vat,l[e]=r,l})},I=async()=>{if(T&&x){L(!0);try{await s.default.patch(`${n}/jobs/${x}/`,{transport_document_no:f,vat_number:N},T);let t=(await s.default.get(`${n}/invoice-items/?job=${x}`,T)).data.map(e=>e.id);t.length>0&&await Promise.all(t.map(e=>s.default.delete(`${n}/invoice-items/${e}/`,T)));let a=g.filter(e=>e.charge_type&&Number(e.amount)>0);await Promise.all(a.map(e=>s.default.post(`${n}/invoice-items/`,{job:Number(x),charge_type:Number(e.charge_type),description:e.description||"Charge",amount:e.amount,vat:e.vat,total:e.total},T))),e.push(`/invoices/${x}/view`)}catch(e){console.error("Save error:",e),alert("Save failed. Please check your data.")}finally{L(!1)}}},W=(0,a.useMemo)(()=>g.reduce((e,t)=>({subtotal:e.subtotal+(Number(t.amount)||0),vat:e.vat+(Number(t.vat)||0),grand:e.grand+(Number(t.total)||0)}),{subtotal:0,vat:0,grand:0}),[g]);return C?(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-slate-50 font-black text-slate-400",children:"LOADING..."}):(0,t.jsxs)("div",{className:"min-h-screen bg-[#F8FAFC] text-slate-900 antialiased pb-20",children:[(0,t.jsx)("header",{className:"bg-white border-b border-slate-200 sticky top-0 z-50",children:(0,t.jsxs)("div",{className:"max-w-7xl mx-auto px-6 h-20 flex justify-between items-center",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)("button",{onClick:()=>e.push("/"),className:"p-2.5 hover:bg-slate-100 rounded-xl transition-all text-slate-400 hover:text-slate-900",children:(0,t.jsx)(d,{})}),(0,t.jsx)("div",{className:"h-8 w-[1px] bg-slate-200 mx-2 hidden md:block"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-lg font-black tracking-tight uppercase",children:"Billing Editor"}),(0,t.jsxs)("p",{className:"text-[10px] font-bold text-blue-600 uppercase tracking-widest",children:["Job ID: #",x," | Ref: ",m?.invoice_no||"Draft"]})]})]}),(0,t.jsx)("button",{onClick:I,disabled:_,className:"bg-black hover:bg-blue-700 disabled:bg-slate-300 text-white px-8 py-3 rounded-2xl font-black text-xs uppercase tracking-[0.15em] transition-all shadow-xl flex items-center gap-3",children:_?"Syncing...":(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(u,{})," Finalize & Save"]})})]})}),(0,t.jsxs)("main",{className:"max-w-7xl mx-auto p-6 md:p-10 grid grid-cols-12 gap-8",children:[(0,t.jsx)("div",{className:"col-span-12 lg:col-span-8 space-y-6",children:(0,t.jsxs)("div",{className:"bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden",children:[(0,t.jsxs)("div",{className:"px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/30",children:[(0,t.jsx)("h2",{className:"text-xs font-black text-slate-400 uppercase tracking-[0.2em]",children:"Service Statement"}),(0,t.jsxs)("button",{onClick:()=>v([...g,{...i}]),className:"text-blue-600 hover:text-black transition flex items-center gap-1 text-xs font-black uppercase",children:[(0,t.jsx)(o,{})," Add Row"]})]}),(0,t.jsx)("div",{className:"p-6 md:p-8 space-y-4",children:g.map((e,a)=>(0,t.jsxs)("div",{className:"group grid grid-cols-12 gap-4 items-end p-5 rounded-2xl bg-slate-50/50 border-2 border-transparent hover:border-blue-100 hover:bg-white transition-all",children:[(0,t.jsxs)("div",{className:"col-span-12 md:col-span-4 relative",children:[(0,t.jsx)("label",{className:"text-[10px] font-black text-slate-400 uppercase mb-2 block",children:"Category"}),(0,t.jsxs)("select",{className:"w-full bg-white border border-slate-200 rounded-xl text-sm font-bold h-12 px-4 focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none",value:e.charge_type,onChange:e=>{"ADD_NEW"===e.target.value?(R(a),$(!0)):M(a,"charge_type",e.target.value)},children:[(0,t.jsx)("option",{value:"",children:"Select Type"}),p.map(e=>(0,t.jsx)("option",{value:e.id,children:e.name},e.id)),(0,t.jsx)("option",{value:"ADD_NEW",className:"font-black text-blue-600 bg-blue-50",children:"+ Add Custom Header..."})]}),(0,t.jsx)("div",{className:"absolute right-4 top-[2.4rem] pointer-events-none text-slate-400",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})})]}),(0,t.jsxs)("div",{className:"col-span-12 md:col-span-5",children:[(0,t.jsx)("label",{className:"text-[10px] font-black text-slate-400 uppercase mb-2 block",children:"Description"}),(0,t.jsx)("input",{className:"w-full bg-white border border-slate-200 rounded-xl text-sm font-bold h-12 px-4 focus:ring-2 focus:ring-blue-500 outline-none transition-all",value:e.description,onChange:e=>M(a,"description",e.target.value),placeholder:"Details..."})]}),(0,t.jsxs)("div",{className:"col-span-10 md:col-span-2",children:[(0,t.jsx)("label",{className:"text-[10px] font-black text-slate-400 uppercase mb-2 block text-right",children:"Amount (OMR)"}),(0,t.jsx)("input",{type:"number",step:"0.001",className:"w-full bg-white border border-slate-200 rounded-xl text-sm font-black h-12 px-4 text-right focus:ring-2 focus:ring-blue-500 outline-none transition-all",value:e.amount,onChange:e=>M(a,"amount",e.target.value)})]}),(0,t.jsx)("div",{className:"col-span-2 md:col-span-1 flex justify-center pb-2",children:(0,t.jsx)("button",{onClick:()=>g.length>1&&v(g.filter((e,t)=>t!==a)),className:"text-slate-300 hover:text-red-500 transition-all p-2",children:(0,t.jsx)(c,{})})})]},a))})]})}),(0,t.jsxs)("div",{className:"col-span-12 lg:col-span-4 space-y-6",children:[(0,t.jsx)("div",{className:"bg-blue-600 rounded-[2rem] p-8 text-white shadow-2xl shadow-blue-200 relative overflow-hidden",children:(0,t.jsxs)("div",{className:"relative z-10",children:[(0,t.jsx)("h3",{className:"text-xs font-black text-blue-200 uppercase tracking-[0.2em] mb-4",children:"Customer Details"}),(0,t.jsx)("p",{className:"text-xl font-black leading-tight mb-6",children:m?.client_details?.name||m?.client?.name||"Loading..."}),(0,t.jsxs)("div",{className:"grid grid-cols-1 gap-4 pt-4 border-t border-blue-500",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"text-[10px] font-black text-blue-200 uppercase",children:"VAT / TRN"}),(0,t.jsx)("input",{value:N,onChange:e=>k(e.target.value),className:"w-full bg-blue-700/50 border-none rounded-xl px-4 py-3 text-sm font-black placeholder:text-blue-400 focus:ring-2 focus:ring-white outline-none mt-1"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"text-[10px] font-black text-blue-200 uppercase",children:"Transport Ref (AWB/BL)"}),(0,t.jsx)("input",{value:f,onChange:e=>j(e.target.value),className:"w-full bg-blue-700/50 border-none rounded-xl px-4 py-3 text-sm font-black placeholder:text-blue-400 focus:ring-2 focus:ring-white outline-none mt-1"})]})]})]})}),(0,t.jsx)("div",{className:"bg-white rounded-[2rem] border border-slate-200 p-8 shadow-sm",children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center text-xs font-bold uppercase tracking-widest text-slate-400",children:[(0,t.jsx)("span",{children:"Subtotal"}),(0,t.jsx)("span",{className:"text-slate-900",children:W.subtotal.toFixed(3)})]}),(0,t.jsxs)("div",{className:"flex justify-between items-center text-xs font-bold uppercase tracking-widest text-slate-400",children:[(0,t.jsx)("span",{children:"VAT (5%)"}),(0,t.jsxs)("span",{className:"text-blue-600",children:["+",W.vat.toFixed(3)]})]}),(0,t.jsxs)("div",{className:"pt-6 mt-2 border-t border-slate-100 flex justify-between items-end",children:[(0,t.jsx)("span",{className:"text-xs font-black uppercase text-slate-900",children:"Grand Total"}),(0,t.jsx)("span",{className:"text-4xl font-black tracking-tighter text-slate-900 tabular-nums",children:W.grand.toFixed(3)})]})]})})]})]}),A&&(0,t.jsx)("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200",children:(0,t.jsxs)("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 space-y-4 scale-100",children:[(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("h3",{className:"text-lg font-black text-slate-900",children:"New Custom Header"}),(0,t.jsx)("p",{className:"text-xs text-slate-400",children:"Enter the name for this new charge category."})]}),(0,t.jsx)("input",{autoFocus:!0,value:B,onChange:e=>D(e.target.value),placeholder:"e.g. Special Handling Fee",className:"w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none",onKeyDown:e=>"Enter"===e.key&&P()}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,t.jsx)("button",{onClick:()=>$(!1),className:"py-3 rounded-xl text-xs font-bold uppercase tracking-wider text-slate-500 hover:bg-slate-100 transition",children:"Cancel"}),(0,t.jsx)("button",{onClick:P,disabled:!B.trim(),className:"py-3 rounded-xl text-xs font-bold uppercase tracking-wider bg-black text-white hover:bg-blue-600 shadow-lg shadow-blue-500/20 transition disabled:opacity-50",children:"Save & Add"})]})]})})]})}e.s(["default",()=>x])}]);