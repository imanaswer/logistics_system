(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,96086,(e,t,a)=>{t.exports=e.r(9187)},83168,e=>{"use strict";let t="https://trans-tracker-4.preview.emergentagent.com";console.log("ðŸ”— Backend API URL:",t),e.s(["API_URL",0,t])},83058,e=>{"use strict";var t=e.i(48277),a=e.i(30668),s=e.i(18033),l=e.i(96086),n=e.i(83168);let r=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"3",d:"M5 13l4 4L19 7"})}),o=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2.5",d:"M12 4v16m8-8H4"})}),i=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),d={charge_type:"",description:"",amount:"",isTaxable:!1,vat:0,total:0};function c(){let e=(0,l.useRouter)(),c=(0,l.useParams)(),u=c?.jobId||c?.id,[x,p]=(0,a.useState)(null),[m,b]=(0,a.useState)([]),[h,g]=(0,a.useState)([d]),[f,j]=(0,a.useState)(0),[v,N]=(0,a.useState)(""),[w,k]=(0,a.useState)(""),[y,_]=(0,a.useState)(""),[S,A]=(0,a.useState)(""),[C,L]=(0,a.useState)(""),[$,I]=(0,a.useState)(!0),[R,T]=(0,a.useState)(!1),[P,D]=(0,a.useState)([]),[B,F]=(0,a.useState)(!1),[U,M]=(0,a.useState)(""),[W,z]=(0,a.useState)(null);(0,a.useEffect)(()=>{u&&(async()=>{let e=localStorage.getItem("token");if(!e){window.location.href="/login";return}try{let t={headers:{Authorization:`Token ${e}`}},[a,l,r,o]=await Promise.all([s.default.get(`${n.API_URL}/api/jobs/${u}/`,t),s.default.get(`${n.API_URL}/api/chargetypes/`,t),s.default.get(`${n.API_URL}/api/invoice-items/?job=${u}`,t),s.default.get(`${n.API_URL}/api/transactions/`,t)]),i=a.data;p(i),b(l.data);let d=o.data.filter(e=>e.job===Number(u)&&["CR","BR"].includes(e.trans_type)).reduce((e,t)=>e+Number(t.amount),0);j(d),N(i.invoice_no||`INV-${new Date().getFullYear()}-${String(u).padStart(3,"0")}`),_(i.transport_document_no||"");let c=i.shipment_invoice_no||"",x="",m="",h="";if(c.includes("(")){let e=c.split("(");h=e.slice(1).join("(").replace(/\)$/,""),c=e[0].trim()}if(c.includes("|||")){let e=c.split("|||");x=e[0].trim(),m=e[1]?.trim()||""}else x=c.includes("||")?c.split("||")[1].trim():c;k(x),A(m),L(h),r.data&&r.data.length>0&&(g(r.data.map(e=>({charge_type:String(e.charge_type),description:e.description,amount:Number(e.amount),isTaxable:Number(e.vat)>0,vat:Number(e.vat),total:Number(e.total)}))),D(r.data.map(e=>e.id))),I(!1)}catch(e){console.error(e),I(!1)}})()},[u]);let E=async()=>{let e=localStorage.getItem("token");if(U.trim()&&e)try{let t={headers:{Authorization:`Token ${e}`}},a=(await s.default.post(`${n.API_URL}/api/chargetypes/`,{name:U},t)).data;b(e=>[...e,a]),null!==W&&H(W,"charge_type",String(a.id)),F(!1),M(""),z(null)}catch(e){alert("Failed to add header.")}},H=(e,t,a)=>{g(s=>{let l=[...s],n={...l[e],[t]:a};if("charge_type"===t){let e=m.find(e=>String(e.id)===a);e&&(n.isTaxable=!!e.name.toLowerCase().match(/custom|transport|handling|agency|clearance/))}let r=Number(n.amount)||0;return("amount"===t||"isTaxable"===t||"charge_type"===t)&&(n.vat=n.isTaxable?.05*r:0,n.total=r+n.vat),l[e]=n,l})},O=async()=>{let t=localStorage.getItem("token"),a=C.trim();a&&!a.startsWith("(")?a=` (${a})`:a&&(a=` ${a}`);let l=`${w} ||| ${S}${a}`;if(l.length>1e3)return alert("Text too long.");T(!0);try{let a={headers:{Authorization:`Token ${t}`}};await s.default.patch(`${n.API_URL}/api/jobs/${u}/`,{invoice_no:v,transport_document_no:y,shipment_invoice_no:l,vat_number:x.vat_number},a),await Promise.allSettled(P.map(e=>s.default.delete(`${n.API_URL}/api/invoice-items/${e}/`,a)));let r=h.filter(e=>e.charge_type&&Number(e.amount)>0);await Promise.all(r.map(e=>s.default.post(`${n.API_URL}/api/invoice-items/`,{job:Number(u),charge_type:Number(e.charge_type),description:e.description,amount:Number(e.amount),vat:Number(e.vat.toFixed(3)),total:Number(e.total.toFixed(3))},a))),e.push(`/invoices/${u}/view`)}catch(e){alert("Save failed"),T(!1)}},G=(0,a.useMemo)(()=>h.reduce((e,t)=>({sub:e.sub+(Number(t.amount)||0),vat:e.vat+t.vat,total:e.total+t.total}),{sub:0,vat:0,total:0}),[h]),K=G.total-f;return $?(0,t.jsx)("div",{className:"h-screen flex items-center justify-center font-bold text-slate-400",children:"LOADING..."}):(0,t.jsxs)("div",{className:"min-h-screen bg-slate-100 p-4 md:p-8 flex justify-center items-center font-sans text-slate-900",children:[(0,t.jsxs)("div",{className:"w-full max-w-6xl bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[600px]",children:[(0,t.jsxs)("div",{className:"flex-grow p-8 md:p-10 flex flex-col relative",children:[(0,t.jsxs)("div",{className:"flex justify-between items-start mb-8",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("h1",{className:"text-2xl font-black tracking-tight mb-1 flex items-center gap-3",children:[(0,t.jsx)("span",{className:"bg-black text-white p-2 rounded-lg",children:(0,t.jsx)(r,{})}),"Billing Generator"]}),(0,t.jsxs)("div",{className:"flex gap-3 text-[10px] font-bold uppercase tracking-widest text-slate-400 mt-1",children:[(0,t.jsxs)("span",{children:["Job ID: #",u]}),(0,t.jsx)("span",{children:"|"}),(0,t.jsxs)("span",{children:["Date: ",x.job_date]})]})]}),(0,t.jsx)("button",{onClick:()=>e.push("/"),className:"text-slate-400 hover:text-red-500 transition",children:(0,t.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}),(0,t.jsxs)("div",{className:"bg-slate-50 p-6 rounded-2xl border border-slate-100 mb-8",children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-[10px] font-black text-slate-400 uppercase mb-1",children:"Invoice No"}),(0,t.jsx)("input",{className:"w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold outline-none focus:border-blue-500",value:v,onChange:e=>N(e.target.value)})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-[10px] font-black text-slate-400 uppercase mb-1",children:"Supplier Reference"}),(0,t.jsx)("input",{className:"w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold outline-none focus:border-blue-500",value:w,onChange:e=>k(e.target.value)})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-[10px] font-black text-slate-400 uppercase mb-1",children:"BL / Ref No"}),(0,t.jsx)("input",{className:"w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold outline-none focus:border-blue-500",value:y,onChange:e=>_(e.target.value),placeholder:"e.g. AWB-123456"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-[10px] font-black text-slate-400 uppercase mb-1",children:"Logistics Manifest (Qty + Type)"}),(0,t.jsx)("input",{className:"w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold outline-none focus:border-blue-500",value:C,onChange:e=>L(e.target.value),placeholder:"e.g. 1x40 ft reefer"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-[10px] font-black text-slate-400 uppercase mb-1",children:"Supplier Information / Description"}),(0,t.jsx)("textarea",{className:"w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-medium outline-none focus:border-blue-500 h-20 resize-none",value:S,onChange:e=>A(e.target.value),placeholder:"Enter details..."})]})]}),(0,t.jsxs)("div",{className:"flex justify-between items-end mb-2 px-2",children:[(0,t.jsx)("span",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:"Line Item Details"}),(0,t.jsxs)("button",{onClick:()=>g([...h,{...d}]),className:"text-[10px] font-black text-blue-600 uppercase flex items-center gap-1 hover:underline",children:[(0,t.jsx)(o,{})," Add New Row"]})]}),(0,t.jsx)("div",{className:"space-y-3 mb-8",children:h.map((e,a)=>(0,t.jsxs)("div",{className:"flex gap-3 items-center group",children:[(0,t.jsxs)("select",{className:"w-1/4 bg-white border border-slate-200 rounded-xl px-3 py-3 text-sm font-bold focus:border-blue-500 outline-none shadow-sm",value:e.charge_type,onChange:e=>{"ADD_NEW"===e.target.value?(z(a),F(!0)):H(a,"charge_type",e.target.value)},children:[(0,t.jsx)("option",{value:"",children:"-- Type --"}),m.map(e=>(0,t.jsx)("option",{value:e.id,children:e.name},e.id)),(0,t.jsx)("option",{value:"ADD_NEW",className:"font-black text-blue-600 bg-blue-50",children:"+ Add Custom Header..."})]}),(0,t.jsx)("input",{className:"flex-grow bg-white border border-slate-200 rounded-xl px-3 py-3 text-sm font-bold focus:border-blue-500 outline-none shadow-sm",placeholder:"Details...",value:e.description,onChange:e=>H(a,"description",e.target.value)}),(0,t.jsx)("div",{className:"flex items-center justify-center px-1",title:"Apply 5% VAT",children:(0,t.jsx)("input",{type:"checkbox",checked:e.isTaxable,onChange:e=>H(a,"isTaxable",e.target.checked),className:"w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer accent-blue-600"})}),(0,t.jsx)("input",{type:"number",className:"w-28 bg-white border border-slate-200 rounded-xl px-3 py-3 text-sm font-bold text-right focus:border-blue-500 outline-none shadow-sm",placeholder:"0.000",value:e.amount,onChange:e=>H(a,"amount",e.target.value)}),(0,t.jsx)("button",{onClick:()=>g(h.filter((e,t)=>t!==a)),className:"text-slate-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition",children:(0,t.jsx)(i,{})})]},a))})]}),(0,t.jsxs)("div",{className:"w-full md:w-96 bg-slate-50 border-l border-slate-200 p-8 md:p-10 flex flex-col justify-center",children:[(0,t.jsx)("h3",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6",children:"Accounting Summary"}),(0,t.jsxs)("div",{className:"space-y-4 text-sm font-bold text-slate-600 mb-8",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Gross Subtotal"}),(0,t.jsx)("span",{children:G.sub.toFixed(3)})]}),(0,t.jsxs)("div",{className:"flex justify-between text-blue-600",children:[(0,t.jsx)("span",{children:"Tax (Oman 5%)"}),(0,t.jsxs)("span",{children:["+",G.vat.toFixed(3)]})]}),(0,t.jsx)("div",{className:"h-px bg-slate-200 my-2"}),(0,t.jsxs)("div",{className:"flex justify-between text-slate-900",children:[(0,t.jsx)("span",{children:"Invoice Amount"}),(0,t.jsx)("span",{children:G.total.toFixed(3)})]}),f>0&&(0,t.jsxs)("div",{className:"flex justify-between text-emerald-600 text-xs",children:[(0,t.jsx)("span",{children:"Prior Credits"}),(0,t.jsxs)("span",{children:["-",f.toFixed(3)]})]})]}),(0,t.jsxs)("div",{className:"bg-slate-900 rounded-2xl p-6 text-white shadow-xl mb-8",children:[(0,t.jsx)("span",{className:"block text-[10px] font-bold text-slate-400 uppercase mb-1",children:"Net Balance Due (OMR)"}),(0,t.jsx)("span",{className:"block text-4xl font-black tracking-tight",children:K>0?K.toFixed(3):"0.000"})]}),(0,t.jsx)("button",{onClick:O,disabled:R,className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition text-xs uppercase tracking-widest disabled:opacity-50",children:R?"Processing...":"Finalize & Record"})]})]}),B&&(0,t.jsx)("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",children:(0,t.jsxs)("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 space-y-4 animate-in fade-in zoom-in duration-200",children:[(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("h3",{className:"text-lg font-black text-slate-900",children:"New Custom Header"}),(0,t.jsx)("p",{className:"text-xs text-slate-400",children:"Add a new category to your billing types."})]}),(0,t.jsx)("input",{autoFocus:!0,value:U,onChange:e=>M(e.target.value),placeholder:"e.g. Special Handling Fee",className:"w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none",onKeyDown:e=>"Enter"===e.key&&E()}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,t.jsx)("button",{onClick:()=>F(!1),className:"py-3 rounded-xl text-xs font-bold uppercase tracking-wider text-slate-500 hover:bg-slate-100 transition",children:"Cancel"}),(0,t.jsx)("button",{onClick:E,disabled:!U.trim(),className:"py-3 rounded-xl text-xs font-bold uppercase tracking-wider bg-black text-white hover:bg-blue-600 shadow-lg transition disabled:opacity-50",children:"Save & Add"})]})]})})]})}e.s(["default",()=>c])}]);